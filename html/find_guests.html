{{ template "base" . }}

{{ define "title" }}{{ "Configuration of guests" | translate }}{{ end }}

{{ define "main" }}
  <p>{{ "List of guests" | translate }}</p>

  {{ if .Guests }}
    <ul id="guests">
      {{ range .Guests }}
        <li>
          {{ .Name }}, <a href="mailto:{{ .Email }}">{{ .Email }}</a> (<a href="/guests/{{ .ID }}/edit">modifier</a>, <a href="" class="delete" data-guest-id="{{ .ID }}">{{ "delete" | translate }}</a>)
        </li>
      {{ end }}
    </ul>
  {{ else }}
    <p>{{ "No guests" | translate }}</p>
  {{ end }}

  <a href="/guests/new">{{ "New guest" | translate }}</a>

  <script>
    const guests = document.getElementById("guests")
    guests.addEventListener("click", function(event) {
      const target = event.target;
      if (target.matches("a.delete")) {
        event.preventDefault();
        deleteGuest(target.dataset.guestId);
      }
    })

    async function deleteGuest(guestId) {
      try {
        const resp = await fetch(`/guests/${guestId}`, { method: "DELETE" })
        if (!resp.ok) {
          throw `server error: http code ${resp.status}`;
        }

        window.location.replace("/guests");
      } catch (error) {
        console.log(error);
      }
    }

    // TODO: implement
    async function api(endpoint, payload) {
      try {
        const resp = await fetch(`/api/${endpoint}`, { method: "POST" })
        if (!resp.ok) {
            // handle error in flash message
            // throw error
        }

        // return data
      } catch (error) {
            // handle error in flash message
            // throw error
      } 
    }

    async function mySpecificAPICall() {
          try {
              data = await api("toto", { "id": 1 })
          } catch (error) {
          }
    }
  </script>
{{ end }}
